---
- hosts: artifactory
  vars:
    artifactory_version: 6.10.7
    docker_skip_registry_login: true
    data_directory: /var/opt/jfrog/artifactory
    artifactory_docker_userid: 1030
    vault_slack_webhook_path: secret/ansible/common/accounts/slack_webhooks/support

  tasks:
    - include_role: name="docker"

    - block:

      - file:
          path: "{{ data_directory }}"
          state: directory
          owner: "{{ artifactory_docker_userid }}"
          group: root
          mode: 0755
        become: yes

      - import_role:
          name: web
        vars:
          nginx_config_template: "templates/nginx-artifactory.j2"
          cert_domains: [ "{{ inventory_hostname }}" ]

      when: artifactory_preconfigured is not defined or not artifactory_preconfigured

    - name: "Installing Artifactory version {{ artifactory_version }}"
      docker_container:
        name: artifactory
        image: "docker.bintray.io/jfrog/artifactory-pro:{{ artifactory_version }}"
        restart_policy: unless-stopped
        ports:
          - "127.0.0.1:9091:8081"
        volumes:
          - "{{ data_directory }}:{{ data_directory }}"
      become: yes

    - block:

      - name: Get Slack webhook URL from vault
        set_fact:
          vault_lookup: "{{ lookup('vault', vault_slack_webhook_path) }}"

      - set_fact:
          slack_support_webhook: "{{ vault_lookup.support.data.url }}"

      - name: Install webhook
        copy:
          src: files/artifactory/webhook.groovy
          dest: "{{ data_directory }}/etc/plugins/webhook.groovy"
          owner: ansible
          group: ansible
          mode: '0444'
        become: yes

      - name: Install webhook config
        template:
          src: templates/artifactory/webhook.config.json.j2
          dest: "{{ data_directory }}/etc/plugins/webhook.config.json"
          owner: ansible
          group: ansible
          mode: '0444'
        become: yes

      when: install_webhook|default(false)
