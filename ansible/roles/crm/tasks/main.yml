- debug: var=item

- assert:
    that:
      - item.openstack_instance is defined or item.cloudlet_name is defined

# Compute cloudlet name

- set_fact:
    cloudlet_name: "{{ item.cloudlet_name }}"
  when: item.cloudlet_name is defined

- set_fact:
    cloudlet_name: "{{ deploy_target }}-{{ item.openstack_instance }}-cloudlet"
  when: item.cloudlet_name is not defined

# Compute CRM name

- set_fact:
    crm_name: "{{ item.crm_name }}"
  when: item.crm_name is defined

- set_fact:
    crm_name: "crm-{{ item.controller }}-{{ item.openstack_instance }}"
  when:
    - item.crm_name is not defined
    - item.openstack_instance is defined

- set_fact:
    crm_name: "crm-{{ cloudlet_name }}"
  when:
    - item.crm_name is not defined
    - item.openstack_instance is not defined

- debug:
    msg: "Deploying {{ crm_name }} (cloudlet name: {{ cloudlet_name }})"

- name: Compute CRM command line
  set_fact:
    crm_args:
      - crmserver
      - "--apiAddr"
      - "0.0.0.0:{{ crm_api_port }}"
      - "--cloudletKey"
      - "{\\\"operator_key\\\":{\\\"name\\\":\\\"{{ item.operator_key | mandatory }}\\\"},\\\"name\\\":\\\"{{ cloudlet_name }}\\\"}"
      - "--vaultAddr"
      - "{{ vault_vm_hostname }}:{{ vault_port }}"
      - "--notifyAddrs"
      - "{{ item.controller }}.ctrl.{{ cloudflare_zone }}:37001"
      - "--notifySrvAddr"
      - 0.0.0.0:{{ crm_srv_notify_notify_port }}"
      - "--tls"
      - "/root/tls/mex-server.crt"
      - "-d"
      - "api,notify,mexos"

- name: Add openstack parameters
  set_fact:
    crm_args: "{{ crm_args + [ '--physicalName', item.openstack_instance ] }}"
  when: item.openstack_instance is defined and item.openstack_instance

- name: Deploy the CRM
  docker_container:
    name: "{{ crm_name }}"
    image: "{{ edge_cloud_image }}:{{ edge_cloud_version }}"
    restart_policy: unless-stopped
    command: "{{ crm_args }}"
    env:
      PLATFORM: "{{ item.platform | default('openstack') }}"
      MEX_EXT_NETWORK: "{{ item.mex_ext_network | default(mex_ext_network) }}"
      VAULT_ROLE_ID: "{{ crm_vault_app_role.role_id }}"
      VAULT_SECRET_ID: "{{ crm_vault_app_role.secret_id }}"
      MEX_SECURITY_GROUP: "{{ item.mex_security_group | default(mex_security_group) }}"

- name: Add CRM to docker network
  docker_network:
    name: "{{ mex_docker_network }}"
    connected:
      - "{{ crm_name }}"
    appends: yes
