- name: Deploy the CRM
  docker_container:
    name: "crm-{{ item.controller }}-{{ item.openstack_instance | mandatory }}"
    image: "{{ edge_cloud_image }}:{{ edge_cloud_version }}"
    restart_policy: unless-stopped
    command:
      - crmserver
      - "--apiAddr"
      - "0.0.0.0:{{ crm_api_port }}"
      - "--cloudletKey"
      - "{\\\"operator_key\\\":{\\\"name\\\":\\\"{{ item.operator_key | mandatory }}\\\"},\\\"name\\\":\\\"{{ deploy_target }}-{{ item.openstack_instance | mandatory }}-cloudlet\\\"}"
      - "--notifyAddrs"
      - "{{ item.controller }}.ctrl.{{ cloudflare_zone }}:37001"
      - "--tls"
      - "/root/tls/mex-server.crt"
      - "-d"
      - "api,notify,mexos"
    env:
      OPENRC_URL: "https://vault.mobiledgex.net/v1/secret/data/cloudlet/openstack/{{ item.openstack_instance | mandatory }}/openrc.json"
      MEXENV_URL: https://vault.mobiledgex.net/v1/secret/data/cloudlet/openstack/mexenv.json
      PLATFORM: openstack
      MEX_EXT_NETWORK: "{{ item.mex_ext_network | default(mex_ext_network) }}"
      VAULT_ROLE_ID: "{{ crm_vault_role_id }}"
      VAULT_SECRET_ID: "{{ crm_vault_secret_id }}"
      MEX_SECURITY_GROUP: "{{ item.mex_security_group | default(mex_security_group) }}"
  with_items: "{{ crm_instances }}"
