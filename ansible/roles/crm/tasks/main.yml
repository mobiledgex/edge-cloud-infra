- debug: var=item

- set_fact:
    k8s_clusters: "{{ hostvars['localhost'].k8s_clusters }}"

- set_fact:
    controller_name: "{{ (k8s_clusters | selectattr('region', 'equalto', item.controller_region) | list | first).name }}"

- assert:
    that:
      - item.cloudlet_name is defined

# Compute CRM name

- set_fact:
    crm_name: "{{ item.crm_name }}"
  when: item.crm_name is defined

- set_fact:
    crm_name: "crm-{{ item.cloudlet_name }}"
  when:
    - item.crm_name is not defined

- debug:
    msg: "Deploying {{ crm_name }} (cloudlet name: {{ item.cloudlet_name }})"

- name: Compute CRM command line
  set_fact:
    crm_args:
      - crmserver
      - "--apiAddr"
      - "0.0.0.0:{{ crm_api_port }}"
      - "--cloudletKey"
      - "{\\\"operator_key\\\":{\\\"name\\\":\\\"{{ item.operator_key | mandatory }}\\\"},\\\"name\\\":\\\"{{ item.cloudlet_name }}\\\"}"
      - "--vaultAddr"
      - "{{ vault_vm_hostname }}:{{ vault_port }}"
      - "--notifyAddrs"
      - "{{ controller_name }}.ctrl.{{ cloudflare_zone }}:37001"
      - "--tls"
      - "/root/tls/mex-server.crt"
      - "-d"
      - "api,notify,mexos"

- name: Add openstack parameters
  set_fact:
    crm_args: "{{ crm_args + [ '--physicalName', item.openstack_instance ] }}"
  when: item.openstack_instance is defined and item.openstack_instance

- name: Deploy the CRM
  docker_container:
    name: "{{ crm_name }}"
    image: "{{ edge_cloud_image }}:{{ edge_cloud_version }}"
    restart_policy: unless-stopped
    command: "{{ crm_args }}"
    env:
      PLATFORM: "{{ item.platform | default('openstack') }}"
      MEX_EXT_NETWORK: "{{ item.mex_ext_network | default(mex_ext_network) }}"
      VAULT_ROLE_ID: "{{ crm_vault_app_role.role_id }}"
      VAULT_SECRET_ID: "{{ crm_vault_app_role.secret_id }}"
      MEX_SECURITY_GROUP: "{{ item.mex_security_group | default(mex_security_group) }}"
