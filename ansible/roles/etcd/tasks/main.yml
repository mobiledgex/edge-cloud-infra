- name: Deploy Etcd Operator
  k8s:
    kubeconfig: "{{ kubeconfig_file.path }}"
    namespace: default
    state: present
    definition: "{{ lookup('template', 'mexplat/etcd-operator.yml') }}"

- name: Wait for Etcd Operator
  command: "kubectl --kubeconfig {{ kubeconfig_file.path }} get customresourcedefinition {{ etcd_opetator_crd }}"
  register: result
  retries: 60
  delay: 5
  until: result is succeeded
  changed_when: false

- name: Deploy Etcd Cluster
  k8s:
    kubeconfig: "{{ kubeconfig_file.path }}"
    namespace: default
    state: present
    definition: "{{ lookup('template', 'mexplat/mex-etcd-cluster.yml') }}"

- name: Wait for Etcd Pods
  command: "kubectl --kubeconfig {{ kubeconfig_file.path }} get pods --selector=etcd_cluster={{ etcd_cluster_name }} -o 'jsonpath={.items[*].metadata.name}' --field-selector='status.phase==Running'"
  register: result
  retries: 60
  delay: 5
  until: result.stdout.split(" ")|length > 2
  changed_when: false
  when: not ansible_check_mode
