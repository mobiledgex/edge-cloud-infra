- name: "Set up nginx ingress controller v{{ nginx_ingress_version }}"
  command: "kubectl --kubeconfig {{ kubeconfig_file.path }} apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-{{ nginx_ingress_version }}/deploy/mandatory.yaml"
  changed_when: no

- name: Set up nginx loadbalancer service
  command: "kubectl --kubeconfig {{ kubeconfig_file.path }} apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-{{ nginx_ingress_version }}/deploy/provider/cloud-generic.yaml"
  changed_when: no

- k8s_facts:
    kubeconfig: "{{ kubeconfig_file.path }}"
    kind: Service
    name: ingress-nginx
    namespace: ingress-nginx
  register: ingress_nginx_facts
  retries: 24
  delay: 5
  until: ingress_nginx_facts.resources[0].status.loadBalancer.ingress[0].ip is defined

- set_fact:
    ingress_ip: "{{ ingress_nginx_facts.resources[0].status.loadBalancer.ingress[0].ip }}"
