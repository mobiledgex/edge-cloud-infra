- name: Deploy Mex Secrets
  k8s:
    kubeconfig: "{{ kubeconfig_file.path }}"
    state: present
    definition: "{{ lookup('template', 'mexplat/mex-secret.yml') }}"

- name: Set up RBAC
  k8s:
    kubeconfig: "{{ kubeconfig_file.path }}"
    state: present
    definition: "{{ lookup('template', 'mexplat/rbac.yml') }}"

- name: "Set up nginx ingress controller v{{ nginx_ingress_version }}"
  command: "kubectl --kubeconfig {{ kubeconfig_file.path }} apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-{{ nginx_ingress_version }}/deploy/mandatory.yaml"

- name: Set up nginx loadbalancer service
  command: "kubectl --kubeconfig {{ kubeconfig_file.path }} apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-{{ nginx_ingress_version }}/deploy/provider/cloud-generic.yaml"

- k8s_facts:
    kubeconfig: "{{ kubeconfig_file.path }}"
    kind: Service
    name: ingress-nginx
    namespace: ingress-nginx
  register: ingress_nginx_facts

- set_fact:
    ingress_ip: "{{ ingress_nginx_facts.resources[0].status.loadBalancer.ingress[0].ip }}"
