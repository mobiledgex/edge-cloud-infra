- block:

    # Attempt to load static kubeconfig
    - name: "Retrieve static kubeconfig for {{ region }}"
      set_fact:
        vault_lookup: "{{ lookup('vault', kubeconfig_path) }}"
      vars:
        kubeconfig_path: "secret/ansible/common/kubeconfigs/static/{{ region | lower }}:kubeconfig"

  rescue:

    # Fall back to using teleport kubeconfig
    - name: "Retrieve teleport kubeconfig for {{ region }}"
      set_fact:
        vault_lookup: "{{ lookup('vault', kubeconfig_path) }}"
      vars:
        kubeconfig_path: "secret/ansible/common/kubeconfigs/{{ region | lower }}:kubeconfig"

- set_fact:
    kubeconfig: "{{ vault_lookup.kubeconfig.data.value | b64decode }}"
