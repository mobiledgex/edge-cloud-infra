- name: Compute mc command line
  set_fact:
    mc_args:
      - mc
      - "-addr"
      - "0.0.0.0:{{ mc_api_port }}"
      - "-sqlAddr"
      - "{{ postgres_hostname }}:5432"
      - "-vaultAddr"
      - "{{ vault_address }}"
      - "-gitlabAddr"
      - "https://{{ gitlab_vm_hostname }}"
      - "-artifactoryAddr"
      - "{{ artifactory_address }}"
      - "-ldapAddr"
      - "0.0.0.0:{{ mc_ldap_port }}"
      - "-tls"
      - "/root/tls/mex-server.crt"
      - "-tlskey"
      - "/root/tls/mex-server.key"
      - "-clientCert"
      - "/root/tls/mex-server.crt"

- name: Add MC tag to command line
  set_fact:
    mc_args: "{{ mc_args + [ '--tag', mc_tag ] }}"
  when: mc_tag is defined and mc_tag

- name: Add MC debug args to command line
  set_fact:
    mc_args: "{{ mc_args + [ '-d', 'api' ] }}"

- name: Deploy the MC
  docker_container:
    name: "{{ mc_vm_hostname.split('.')[0]|lower }}"
    image: "{{ edge_cloud_image }}:{{ edge_cloud_version }}"
    restart_policy: unless-stopped
    command: "{{ mc_args }}"
    ports:
      - "127.0.0.1:{{ mc_api_internal_port }}:{{ mc_api_port }}"
      - "{{ mc_ldap_port }}:{{ mc_ldap_port }}"
    env:
      db_name: "{{ mc_postgres_db }}"
      db_username: "{{ mc_postgres_username }}"
      db_password: "{{ mc_postgres_password }}"
      superuser: "{{ mc_superuser }}"
      superpass: "{{ mc_superuser_password }}"
      VAULT_ROLE_ID: "{{ mc_vault_role_id }}"
      VAULT_SECRET_ID: "{{ mc_vault_secret_id }}"
      gitlab_token: "{{ mc_gitlab_token }}"
      artifactory_apikey: "{{ mc_artifactory_apikey }}"
