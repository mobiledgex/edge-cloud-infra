- hosts: localhost
  gather_facts: no
  tasks:
    - import_role:
        name: vault
        tasks_from: load-token

- hosts: localhost
  gather_facts: no
  vars:
    github_org: mobiledgex
    github_token_ttl: 900 # seconds
  module_defaults:
    vault_policy:
      vault_addr: "{{ vault_address }}"
      vault_token: "{{ vault_token }}"
    vault_role:
      vault_addr: "{{ vault_address }}"
      vault_token: "{{ vault_token }}"
    vault_api:
      vault_addr: "{{ vault_address }}"
      vault_token: "{{ vault_token }}"

  tasks:
    - name: Check if Github auth is enabled
      vault_api:
        api: sys/auth
      register: result
      changed_when: no
      tags: setup

    - name: Enable Github auth
      vault_api:
        api: sys/auth/github
        method: POST
        data:
          type: github
          description: Log in with Github
        success_code: 204
      when:
        - "'github/' not in result.meta.response"
      tags: setup

    - name: Check Github auth config
      vault_api:
        api: auth/github/config
      register: result
      changed_when: no
      ignore_errors: yes
      tags: setup

    - name: Configure Github auth
      vault_api:
        api: auth/github/config
        method: POST
        data:
          organization: "{{ github_org }}"
          ttl: "{{ github_token_ttl }}s"
          max_ttl: "{{ github_token_ttl }}s"
        success_code: 204
      when: ("meta" not in result) or
            (result.meta.response.data.organization != github_org) or
            (result.meta.response.data.ttl != github_token_ttl) or
            (result.meta.response.data.max_ttl != github_token_ttl)
      tags: setup

    - include_role:
        name: vault
        tasks_from: github-teams
      loop: "{{ vault_github_teams }}"
      loop_control:
        loop_var: team
      tags: setup

    - import_role:
        name: vault
        tasks_from: policies
      tags:
        - policies
        - setup

    - import_role:
        name: vault
        tasks_from: roles
      tags:
        - roles
        - setup
