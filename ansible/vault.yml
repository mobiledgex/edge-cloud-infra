- hosts: vault
  tasks:

    - import_role:
        name: ntp
      tags: setup

    - import_role:
        name: docker
      tags: setup

    - import_role:
        name: web
        tasks_from: certs
      vars:
        cert_domains: "{{ [ vault_vm_hostname ] + additional_vault_domains.split(',') }}"
        post_renewal_hooks:
          - hook_name: vault_reload_hook
            hook_content: |
              #!/bin/bash
              systemctl reload vault
      tags: setup

    - name: Set up vault firewall rules
      import_role:
        name: gcp_firewall
        tasks_from: vault
      tags: setup

    - name: Set up vault
      import_role:
        name: vault
      vars:
        storage_bucket_name: "mex-vault-{{ deploy_environ }}"
        project: "{{ gcp_project }}"
        storage_service_account_key: "/etc/gcloud/{{ storage_bucket_name }}.json"
