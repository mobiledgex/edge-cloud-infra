
heat_template_version: 2016-10-14
description: Create a group of VMs

resources:
    test-new-subnet:
        type: OS::Neutron::Subnet
        properties:
            cidr: 10.101.99.0/24
            network: mex-k8s-net-1
            gateway_ip: 
            enable_dhcp: no
            dns_nameservers:
                 - 1.1.1.1
                 - 1.0.0.1
            name: 
                test-new-subnet
    rootlb-external-port:
        type: OS::Neutron::Port
        properties:
            name: rootlb-external-port
            network: external-network-shared
            security_groups:
                - default
                - { get_resource: test-secgrp }
    rootlb-internal-port:
        type: OS::Neutron::Port
        properties:
            name: rootlb-internal-port
            network: mex-k8s-net-1
            fixed_ips:
                - ip_address:  10.101.99.1
                  subnet: { get_resource: test-new-subnet }
            security_groups:
                - { get_resource: test-secgrp }
    master-port:
        type: OS::Neutron::Port
        properties:
            name: master-port
            network: mex-k8s-net-1
            fixed_ips:
                - ip_address:  10.101.99.10
                  subnet: { get_resource: test-new-subnet }
            security_groups:
                - { get_resource: test-secgrp }
    test-secgrp:
        type: OS::Neutron::SecurityGroup
        properties:
                name: test-secgrp
                rules:
                    - direction: egress
                      protocol: TCP
                      remote_ip_prefix: 47.0.0.0/8
                      port_range_min: 4000
                      port_range_max: 4002
                    - direction: ingress
                      remote_ip_prefix: 0.0.0.0/0
                      protocol: TCP
                      port_range_min: 8443
                      port_range_max: 8443
                    - direction: ingress
                      remote_ip_prefix: 0.0.0.0/0
                      protocol: UDP
                      port_range_min: 9000
                      port_range_max: 9002
        
    rootlb1:
        type: OS::Nova::Server
        properties:
            name: rootlb1
            networks:
                - port: { get_resource: rootlb-external-port }
                - port: { get_resource: rootlb-internal-port }
            image: mobiledgex-v3.1.0 
            flavor: m4.medium
            config_drive: true
            user_data_format: RAW
            user_data: |


        
    master:
        type: OS::Nova::Server
        properties:
            name: master
            networks:
                - port: { get_resource: master-port }
            image: mobiledgex-v3.1.0 
            flavor: m4.medium
            config_drive: true
            user_data_format: RAW
            user_data: |


    fip-test1:
        type: OS::Neutron::FloatingIPAssociation
        properties:
            floatingip_id: 4eedb4bd-b5cb-4738-8b4f-11254e181b8b
            port_id: { get_resource: rootlb-internal-port }
