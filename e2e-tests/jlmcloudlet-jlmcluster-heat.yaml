
heat_template_version: 2016-10-14
description: Create a cluster

resources:
   k8s-subnet:
      type: OS::Neutron::Subnet
      properties:
        cidr: 10.101.12.0/24
        network: mex-k8s-net-1
        gateway_ip: 10.101.12.1
        enable_dhcp: false
        name: 
           mex-k8s-subnet-jlmcloudlet-jlmcluster

   router-port:
       type: OS::Neutron::Port
       properties:
          name: mex-k8s-subnet-jlmcloudlet-jlmcluster
          network_id: mex-k8s-net-1
          fixed_ips:
          - subnet: { get_resource: k8s-subnet}
            ip_address: 10.101.12.1
          security_groups:
           - default

   router-interface:
      type: OS::Neutron::RouterInterface
      properties:
         router:  mex-k8s-router-1
         port: { get_resource: router-port }

   k8s-master-port:
      type: OS::Neutron::Port
      properties:
         name: k8s-master-port
         network_id: mex-k8s-net-1
         fixed_ips:
          - subnet: { get_resource: k8s-subnet} 
            ip_address: 10.101.12.2
         security_groups:
          - default

   k8s_master:
      type: OS::Nova::Server
      properties:
         name: 
            mex-k8s-master-jlmcloudlet-jlmcluster
         image: mobiledgex-v2.0.2
         flavor: m4.medium
         config_drive: true
         user_data_format: RAW
         user_data:
            get_file: /root/.mobiledgex/userdata.txt
         networks:
          - port: { get_resource: k8s-master-port }
         metadata:
            skipk8s: no
            role: k8s-master 
            edgeproxy: 10.101.12.1
            mex-flavor: m4.medium
            k8smaster: 10.101.12.2

  
   mex-k8s-node-1-port:
      type: OS::Neutron::Port
      properties:
          name: mex-k8s-master-port-jlmcloudlet-jlmcluster
          network_id: mex-k8s-net-1
          fixed_ips:
          - subnet: { get_resource: k8s-subnet}
            ip_address: 10.101.12.101
          security_groups:
           - default

   mex-k8s-node-1:
      type: OS::Nova::Server
      depends_on: k8s_master
      properties:
         name: mex-k8s-node-1-jlmcloudlet-jlmcluster
         image: mobiledgex-v2.0.2
         flavor: m4.medium
         config_drive: true
         user_data_format: RAW
         user_data:
            get_file: /root/.mobiledgex/userdata.txt
         networks:
          - port: { get_resource: mex-k8s-node-1-port } 
         metadata:
            skipk8s: no 
            role: k8s-node
            edgeproxy: 10.101.12.1
            mex-flavor: m4.medium
            k8smaster: 10.101.12.2
  
