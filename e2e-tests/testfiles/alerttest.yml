##
description: run Alert and Alertmanager tests. Assumes edge-cloud objects already present

tests:
  - name: verify that no alerts are present
    actions: [mcapi-showalerts]
    apifile: '{{datadir2}}/show_local_region.yml'
    curuserfile: '{{datadir2}}/mc_admin.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/mcappdata_empty.yml'
      filetype: mcalerts

  - name: verify that no emails about alerts are present
    actions: [email-check]
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/mcappdata_empty.yml'
      filetype: emaildata

  - name: create alert receiver
    actions: [mcapi-create]
    apifile: '{{datadir2}}/mc_admin_alert_receiver.yml'
    curuserfile: '{{datadir2}}/mc_admin.yml'

  - name: verify alert receiver was created
    actions: [mcapi-showalertreceivers]
    curuserfile: '{{datadir2}}/mc_admin.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/mc_admin_data_alert_receiver_show.yml'
      filetype: mcdata

  - name: set healthy backend servers to 0
    actions: [cmds]
    apifile: "{{datadir2}}/alert_appinstdown"

  - name: check health check alerts
    actions: [mcapi-showalerts]
    apifile: '{{datadir2}}/show_local_region.yml'
    curuserfile: '{{datadir2}}/mc_admin.yml'
    retrycount: 10
    retryintervalsec: 0.5
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/health_check_down_alerts_show.yml'
      filetype: mcalerts

  - name: verify that email notification about an alert was sent
    actions: [email-check]
    retrycount: 10
    retryintervalsec: 0.5
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/emaildata_alert_firing.yml'
      filetype: emaildata

  - name: set healthy backend servers to 1
    actions: [cmds]
    apifile: "{{datadir2}}/alert_appinstup"

  - name: check health check alerts cleared
    actions: [mcapi-showalerts]
    apifile: '{{datadir2}}/show_local_region.yml'
    curuserfile: '{{datadir2}}/mc_admin.yml'
    retrycount: 10
    retryintervalsec: 0.5
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/mcappdata_empty.yml'
      filetype: mcalerts

  - name: verify that email notification about an alert resoltion was sent
    actions: [email-check]
    retrycount: 10
    retryintervalsec: 0.5
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/emaildata_alert_resolved.yml'
      filetype: emaildata

  - name: delete alert receiver
    actions: [mcapi-delete]
    apifile: '{{datadir2}}/mc_admin_alert_receiver.yml'
    curuserfile: '{{datadir2}}/mc_admin.yml'

  - name: verify no alert receivers are present
    actions: [mcapi-showalertreceivers]
    curuserfile: '{{datadir2}}/mc_admin.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/mcappdata_empty.yml'
      filetype: mcdata
  
  - name: delete all emails and verify that mailbox is empty
    actions: [email-deleteall, email-check]
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/mcappdata_empty.yml'
      filetype: emaildata
