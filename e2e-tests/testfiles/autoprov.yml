##
description: run auto-prov test. Assumes edge-cloud objects already present

tests:
  - name: find cloudlet for auto-prov app (1 of 3)
    apifile: "{{datadir2}}/find_cloudlet_ap.yml"
    actions: [dmeapi-findcloudlet]
  - name: find cloudlet for auto-prov app (2 of 3)
    apifile: "{{datadir2}}/find_cloudlet_ap.yml"
    actions: [dmeapi-findcloudlet]
  - name: find cloudlet for auto-prov app (3 of 3)
    apifile: "{{datadir2}}/find_cloudlet_ap.yml"
    actions: [dmeapi-findcloudlet]

  - name: find cloudlet for auto-prov docker app (1 of 3)
    apifile: "{{datadir2}}/find_cloudlet_apd.yml"
    actions: [dmeapi-findcloudlet]
  - name: find cloudlet for auto-prov docker app (2 of 3)
    apifile: "{{datadir2}}/find_cloudlet_apd.yml"
    actions: [dmeapi-findcloudlet]
  - name: find cloudlet for auto-prov docker app (3 of 3)
    apifile: "{{datadir2}}/find_cloudlet_apd.yml"
    actions: [dmeapi-findcloudlet]

  - name: sleep, allow extra time for auto-prov to create AppInst
    actions: [sleep=1]
  - name: check that AppInsts were auto-provisioned
    actions: [mcapi-showfiltered]
    apifile: '{{datadir2}}/autoprov_appinst.yml'
    curuserfile: '{{datadir2}}/mc_user2.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/autoprov_appinst_show.yml'
      filetype: mcdata
  - name: delete auto-provisioned AppInsts
    actions: [mcapi-delete]
    apifile: '{{datadir2}}/autoprov_appinst.yml'
    curuserfile: '{{datadir2}}/mc_user2.yml'

  - name: create auto-prov HA app and policy, will trigger auto-deployment
    actions: [mcapi-create]
    apifile: '{{datadir2}}/autoprov_ha_app.yml'
    curuserfile: '{{datadir2}}/mc_user2.yml'

  - name: check that HA AppInsts were created
    actions: [mcapi-showfiltered]
    apifile: '{{datadir2}}/autoprov_ha_appinst_filter.yml'
    curuserfile: '{{datadir2}}/mc_user2.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/autoprov_ha_appinst_show.yml'
      filetype: mcdata

  - name: remove Cloudlet from policy, will trigger failover and orphaned cleanup
    actions: [mcapi-remove]
    apifile: '{{datadir2}}/autoprov_ha_policycloudlet.yml'
    curuserfile: '{{datadir2}}/mc_user2.yml'

  - name: check that HA AppInsts were failed over
    actions: [mcapi-showfiltered]
    apifile: '{{datadir2}}/autoprov_ha_appinst_filter.yml'
    curuserfile: '{{datadir2}}/mc_user2.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/autoprov_ha_appinst_failedover.yml'
      filetype: mcdata

  - name: delete auto-prov HA app and policy
    actions: [mcapi-delete]
    apifile: '{{datadir2}}/autoprov_ha_app.yml'
    curuserfile: '{{datadir2}}/mc_user2.yml'

  - name: check that HA AppInsts were deleted
    actions: [mcapi-showfiltered]
    apifile: '{{datadir2}}/autoprov_ha_appinst_filter.yml'
    curuserfile: '{{datadir2}}/mc_user2.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/autoprov_ha_appinst_empty.yml'
      filetype: mcdata
