##
##
description: Deploys and starts a system. Does not stop or cleanup

tests:
  - includefile: {{edge-cloud-testfiles}}/stop_cleanup.yml
  - includefile: deploy_start.yml
  - includefile: federation_setup_users.yml

  - name: admin creates controllers, flavors, sets up enterprise; verify it is there
    actions: [mcapi-create=mc1op1, mcapi-show=mc1op1]
    apifile: '{{datadir2}}/federation_admin_data.yml'
    apifilevars:
      suffix: op1
      ctrl_port: "55001"
      ctrl_notify_port: "37001"
      influxdb_port: "8086"
    curuserfile: '{{datadir2}}/mc_admin.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/federation_admin_data.yml'
      yaml2vars:
        suffix: op1
        ctrl_port: "55001"
        ctrl_notify_port: "37001"
        influxdb_port: "8086"
      filetype: mcdata

  - name: user1 creates operators
    actions: [mcapi-create=mc1op1]
    apifile: '{{datadir2}}/federation_user1_org_data.yml'
    apifilevars:
      suffix: op1
    curuserfile: '{{datadir2}}/federation_user1.yml'

  - name: admin marks operator orgs an non-edgebox only
    actions: [mcapi-restrictedupdateorg=mc1op1]
    apifile: '{{datadir2}}/federation_user1_org_update.yml'
    apifilevars:
      suffix: op1
    curuserfile: '{{datadir2}}/mc_admin.yml'

  - name: user1 creates cloudlets; verify it is there
    actions: [mcapi-create=mc1op1, mcapi-show=mc1op1]
    apifile: '{{datadir2}}/federation_user1_cloudlet_data.yml'
    apifilevars:
      suffix: op1
      ctrl_port: "55001"
      ctrl_notify_port: "37001"
      influxdb_port: "8086"
    curuserfile: '{{datadir2}}/federation_user1.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/federation_user1_data_show.yml'
      yaml2vars:
        suffix: op1
        ctrl_port: "55001"
        ctrl_notify_port: "37001"
        influxdb_port: "8086"
      filetype: mcdata

  - name: admin creates controllers, flavors, sets up enterprise; verify it is there
    actions: [mcapi-create=mc1op2, mcapi-show=mc1op2]
    apifile: '{{datadir2}}/federation_admin_data.yml'
    apifilevars:
      suffix: op2
      ctrl_port: "55011"
      ctrl_notify_port: "37011"
      influxdb_port: "8087"
    curuserfile: '{{datadir2}}/mc_admin.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/federation_admin_data.yml'
      yaml2vars:
        suffix: op2
        ctrl_port: "55011"
        ctrl_notify_port: "37011"
        influxdb_port: "8087"
      filetype: mcdata

  - name: user1 creates operators
    actions: [mcapi-create=mc1op2]
    apifile: '{{datadir2}}/federation_user1_org_data.yml'
    apifilevars:
      suffix: op2
    curuserfile: '{{datadir2}}/federation_user1.yml'

  - name: admin marks operator orgs an non-edgebox only
    actions: [mcapi-restrictedupdateorg=mc1op2]
    apifile: '{{datadir2}}/federation_user1_org_update.yml'
    apifilevars:
      suffix: op2
    curuserfile: '{{datadir2}}/mc_admin.yml'

  - name: user1 creates cloudlets; verify it is there
    actions: [mcapi-create=mc1op2, mcapi-show=mc1op2]
    apifile: '{{datadir2}}/federation_user1_cloudlet_data.yml'
    apifilevars:
      suffix: op2
      ctrl_port: "55011"
      ctrl_notify_port: "37011"
      influxdb_port: "8087"
    curuserfile: '{{datadir2}}/federation_user1.yml'
    compareyaml:
      yaml1: '{{outputdir}}/show-commands.yml'
      yaml2: '{{datadir2}}/federation_user1_data_show.yml'
      yaml2vars:
        suffix: op2
        ctrl_port: "55011"
        ctrl_notify_port: "37011"
        influxdb_port: "8087"
      filetype: mcdata
