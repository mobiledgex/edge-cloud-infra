description: test mc rate limiting

tests:

- name: setup config to enable rate limiting
  actions: [mcapi-configupdate,mcapi-configshow]
  apifile: '{{datadir2}}/mcconfig_ratelimit.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mcconfig_ratelimit_show.yml'
    filetype: mcconfig

- name: show default mc rate limit settings
  actions: [mcapi-mcratelimitshow]
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_default_show.yml'
    filetype: mcratelimit

- name: create rate limit settings for ShowApp api
  actions: [mcapi-mcratelimitcreate,mcapi-mcratelimitshow]
  apifile: '{{datadir2}}/mc_ratelimit_create.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_create_show.yml'
    filetype: mcratelimit

- name: update rate limit settings for ShowApp api
  actions: [mcapi-mcratelimitupdate,mcapi-mcratelimitshow]
  apifile: '{{datadir2}}/mc_ratelimit_update.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_update_show.yml'
    filetype: mcratelimit

- name: ShowApp successful
  actions: [mcapi-showfiltered]
  apifile: '{{datadir2}}/mc_ratelimit_showapp.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_showapp_show.yml'
    filetype: mcdata

- name: ShowApp rate limited (fail)
  actions: [mcapi-showfiltered-expecterr]
  apifile: '{{datadir2}}/mc_ratelimit_showapp.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/api-output.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_showapp_fail_show.yml'
    filetype: errs

- name: sleep, allow time token bucket to refill
  actions: [sleep=2]

- name: ShowApp successful after token bucket refilled
  actions: [mcapi-showfiltered]
  apifile: '{{datadir2}}/mc_ratelimit_showapp.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_showapp_show.yml'
    filetype: mcdata

- name: delete rate limit settings for ShowApp api
  actions: [mcapi-mcratelimitdelete,mcapi-mcratelimitshow]
  apifile: '{{datadir2}}/mc_ratelimit_delete.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_default_show.yml'
    filetype: mcratelimit

- name: ShowApp successful
  actions: [mcapi-showfiltered]
  apifile: '{{datadir2}}/mc_ratelimit_showapp.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_showapp_show.yml'
    filetype: mcdata

- name: ShowApp again still successful after rate limit settings deleted
  actions: [mcapi-showfiltered]
  apifile: '{{datadir2}}/mc_ratelimit_showapp.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_ratelimit_showapp_show.yml'
    filetype: mcdata

- name: reset config
  actions: [mcapi-configupdate,mcapi-configshow]
  apifile: '{{datadir2}}/mcconfig.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mcconfig.yml'
    filetype: mcconfig
