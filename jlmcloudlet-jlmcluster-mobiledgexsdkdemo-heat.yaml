
heat_template_version: 2016-10-14
description: Create a cluster

resources:
   k8s-subnet:
      type: OS::Neutron::Subnet
      properties:
        cidr: 10.101.13.0/24
        network: mex-k8s-net-1
        gateway_ip: 10.101.13.1
        enable_dhcp: false
        dns_nameservers:
       
         - 1.1.1.1
       
         - 1.0.0.1
       
        name: 
           mex-k8s-subnet-jlmcloudlet-jlmcluster-mobiledgexsdkdemo
  
   rootlb-port:
      type: OS::Neutron::Port
      properties:
         name: jlmcloudlet.gddt.mobiledgex.net-jlmcloudlet-jlmcluster-mobiledgexsdkdemo-port
         network_id: mex-k8s-net-1
         fixed_ips:
          - subnet: { get_resource: k8s-subnet}
            ip_address: 10.101.13.1
         port_security_enabled: false
  
   mex-k8s-master-jlmcloudlet-jlmcluster-mobiledgexsdkdemo-port:
      type: OS::Neutron::Port
      properties:
         name: mex-k8s-master-jlmcloudlet-jlmcluster-mobiledgexsdkdemo-port
        
         network_id: mex-k8s-net-1
         fixed_ips:
          - subnet: { get_resource: k8s-subnet} 
            ip_address: 10.101.13.10
        
         port_security_enabled: false

  
  
   mex-k8s-master-jlmcloudlet-jlmcluster-mobiledgexsdkdemo:
      type: OS::Nova::Server
      properties:
         name: mex-k8s-master-jlmcloudlet-jlmcluster-mobiledgexsdkdemo
        
      
         image: mobiledgex-v3.0.3
         flavor: m4.large-gpu
         config_drive: true
         user_data_format: RAW
         user_data: |
            #cloud-config
            bootcmd:
             - echo MOBILEDGEX CLOUD CONFIG START
             - echo 'APT::Periodic::Enable "0";' > /etc/apt/apt.conf.d/10cloudinit-disable
             - apt-get -y purge update-notifier-common ubuntu-release-upgrader-core landscape-common unattended-upgrades
             - echo "Removed APT and Ubuntu extra packages" | systemd-cat
            ssh_authorized_keys:
             - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCrHlOJOJUqvd4nEOXQbdL8ODKzWaUxKVY94pF7J3diTxgZ1NTvS6omqOjRS3loiU7TOlQQU4cKnRRnmJW8QQQZSOMIGNrMMInGaEYsdm6+tr1k4DDfoOrkGMj3X/I2zXZ3U+pDPearVFbczCByPU0dqs16TWikxDoCCxJRGeeUl7duzD9a65bI8Jl+zpfQV+I7OPa81P5/fw15lTzT4+F9MhhOUVJ4PFfD+d6/BLnlUfZ94nZlvSYnT+GoZ8xTAstM7+6pvvvHtaHoV4YqRf5CelbWAQ162XNa9/pW5v/RKDrt203/JEk3e70tzx9KAfSw2vuO1QepkCZAdM9rQoCd ubuntu@registry
            chpasswd: { expire: False }
            ssh_pwauth: False
            timezone: UTC
            runcmd:
             - [ echo, MOBILEDGEX, doing, ifconfig ]
             - [ ifconfig, -a ]
        
         networks:
          - port: { get_resource: mex-k8s-master-jlmcloudlet-jlmcluster-mobiledgexsdkdemo-port }
         metadata:
         
           skipk8s: no
           role: k8s-master 
           edgeproxy: 10.101.13.1
           mex-flavor: m4.large-gpu
           k8smaster: 10.101.13.10
         
  
   mex-k8s-node-1-port:
      type: OS::Neutron::Port
      properties:
          name: mex-k8s-mex-k8s-node-1-port-jlmcloudlet-jlmcluster-mobiledgexsdkdemo
         
          network_id: mex-k8s-net-1
          fixed_ips:
          - subnet: { get_resource: k8s-subnet}
            ip_address: 10.101.13.101
         
          port_security_enabled: false

  

   mex-k8s-node-1:
      type: OS::Nova::Server
      depends_on: mex-k8s-master-jlmcloudlet-jlmcluster-mobiledgexsdkdemo
      properties:
         name: mex-k8s-node-1-jlmcloudlet-jlmcluster-mobiledgexsdkdemo
        
        
         
         image: mobiledgex-v3.0.3
         flavor: m4.large-gpu
         config_drive: true
         user_data_format: RAW
         user_data: |
            #cloud-config
            bootcmd:
             - echo MOBILEDGEX CLOUD CONFIG START
             - echo 'APT::Periodic::Enable "0";' > /etc/apt/apt.conf.d/10cloudinit-disable
             - apt-get -y purge update-notifier-common ubuntu-release-upgrader-core landscape-common unattended-upgrades
             - echo "Removed APT and Ubuntu extra packages" | systemd-cat
            ssh_authorized_keys:
             - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCrHlOJOJUqvd4nEOXQbdL8ODKzWaUxKVY94pF7J3diTxgZ1NTvS6omqOjRS3loiU7TOlQQU4cKnRRnmJW8QQQZSOMIGNrMMInGaEYsdm6+tr1k4DDfoOrkGMj3X/I2zXZ3U+pDPearVFbczCByPU0dqs16TWikxDoCCxJRGeeUl7duzD9a65bI8Jl+zpfQV+I7OPa81P5/fw15lTzT4+F9MhhOUVJ4PFfD+d6/BLnlUfZ94nZlvSYnT+GoZ8xTAstM7+6pvvvHtaHoV4YqRf5CelbWAQ162XNa9/pW5v/RKDrt203/JEk3e70tzx9KAfSw2vuO1QepkCZAdM9rQoCd ubuntu@registry
            chpasswd: { expire: False }
            ssh_pwauth: False
            timezone: UTC
            runcmd:
             - [ echo, MOBILEDGEX, doing, ifconfig ]
             - [ ifconfig, -a ]
         networks:
          - port: { get_resource: mex-k8s-node-1-port } 
         metadata:
            skipk8s: no 
            role: k8s-node
            edgeproxy: 10.101.13.1
            mex-flavor: m4.large-gpu
            k8smaster: 10.101.13.10
  
   mex-k8s-node-2-port:
      type: OS::Neutron::Port
      properties:
          name: mex-k8s-mex-k8s-node-2-port-jlmcloudlet-jlmcluster-mobiledgexsdkdemo
         
          network_id: mex-k8s-net-1
          fixed_ips:
          - subnet: { get_resource: k8s-subnet}
            ip_address: 10.101.13.102
         
          port_security_enabled: false

  

   mex-k8s-node-2:
      type: OS::Nova::Server
      depends_on: mex-k8s-master-jlmcloudlet-jlmcluster-mobiledgexsdkdemo
      properties:
         name: mex-k8s-node-2-jlmcloudlet-jlmcluster-mobiledgexsdkdemo
        
        
         
         image: mobiledgex-v3.0.3
         flavor: m4.large-gpu
         config_drive: true
         user_data_format: RAW
         user_data: |
            #cloud-config
            bootcmd:
             - echo MOBILEDGEX CLOUD CONFIG START
             - echo 'APT::Periodic::Enable "0";' > /etc/apt/apt.conf.d/10cloudinit-disable
             - apt-get -y purge update-notifier-common ubuntu-release-upgrader-core landscape-common unattended-upgrades
             - echo "Removed APT and Ubuntu extra packages" | systemd-cat
            ssh_authorized_keys:
             - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCrHlOJOJUqvd4nEOXQbdL8ODKzWaUxKVY94pF7J3diTxgZ1NTvS6omqOjRS3loiU7TOlQQU4cKnRRnmJW8QQQZSOMIGNrMMInGaEYsdm6+tr1k4DDfoOrkGMj3X/I2zXZ3U+pDPearVFbczCByPU0dqs16TWikxDoCCxJRGeeUl7duzD9a65bI8Jl+zpfQV+I7OPa81P5/fw15lTzT4+F9MhhOUVJ4PFfD+d6/BLnlUfZ94nZlvSYnT+GoZ8xTAstM7+6pvvvHtaHoV4YqRf5CelbWAQ162XNa9/pW5v/RKDrt203/JEk3e70tzx9KAfSw2vuO1QepkCZAdM9rQoCd ubuntu@registry
            chpasswd: { expire: False }
            ssh_pwauth: False
            timezone: UTC
            runcmd:
             - [ echo, MOBILEDGEX, doing, ifconfig ]
             - [ ifconfig, -a ]
         networks:
          - port: { get_resource: mex-k8s-node-2-port } 
         metadata:
            skipk8s: no 
            role: k8s-node
            edgeproxy: 10.101.13.1
            mex-flavor: m4.large-gpu
            k8smaster: 10.101.13.10
  
