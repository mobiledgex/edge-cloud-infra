
heat_template_version: 2016-10-14
description: Create a cluster

resources:
   k8s-subnet:
      type: OS::Neutron::Subnet
      properties:
        cidr: 10.101.8.0/24
        network: mex-k8s-net-1
        gateway_ip: 10.101.8.1
        enable_dhcp: false
        dns_nameservers:
       
        name: 
           mex-k8s-subnet-jlm-vmapp1
  
   rootlb-port:
      type: OS::Neutron::Port
      properties:
         name: jlmheattest.mobiledgex.net-jlm-vmapp1-port
         network_id: mex-k8s-net-1
         fixed_ips:
          - subnet: { get_resource: k8s-subnet}
            ip_address: 10.101.8.1
         port_security_enabled: false
  
   mex-vm-app-port:
      type: OS::Neutron::Port
      properties:
         name: mex-vm-app-port
        
         network_id: mex-k8s-net-1
         fixed_ips:
          - subnet: { get_resource: k8s-subnet} 
            ip_address: 10.101.8.10
        
         port_security_enabled: false

  
  
   mex-vm-app:
      type: OS::Nova::Server
      properties:
         name: mex-vm-app-jlm-vmapp1
        
      
         image: mobiledgex-v3.0.3
         flavor: m4.medium
         config_drive: true
         user_data_format: RAW
         user_data: |
            #cloud-config
            bootcmd:
             - echo MOBILEDGEX CLOUD CONFIG START
             - echo 'APT::Periodic::Enable "0";' > /etc/apt/apt.conf.d/10cloudinit-disable
             - apt-get -y purge update-notifier-common ubuntu-release-upgrader-core landscape-common unattended-upgrades
             - echo "Removed APT and Ubuntu extra packages" | systemd-cat
            ssh_authorized_keys:
             - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCrHlOJOJUqvd4nEOXQbdL8ODKzWaUxKVY94pF7J3diTxgZ1NTvS6omqOjRS3loiU7TOlQQU4cKnRRnmJW8QQQZSOMIGNrMMInGaEYsdm6+tr1k4DDfoOrkGMj3X/I2zXZ3U+pDPearVFbczCByPU0dqs16TWikxDoCCxJRGeeUl7duzD9a65bI8Jl+zpfQV+I7OPa81P5/fw15lTzT4+F9MhhOUVJ4PFfD+d6/BLnlUfZ94nZlvSYnT+GoZ8xTAstM7+6pvvvHtaHoV4YqRf5CelbWAQ162XNa9/pW5v/RKDrt203/JEk3e70tzx9KAfSw2vuO1QepkCZAdM9rQoCd ubuntu@registry
            chpasswd: { expire: False }
            ssh_pwauth: False
            timezone: UTC
            runcmd:
             - [ echo, MOBILEDGEX, doing, ifconfig ]
             - [ ifconfig, -a ]
        
         networks:
          - port: { get_resource: mex-vm-app-port }
         metadata:
         
           skipk8s: yes
           role: mex-agent-node 
           edgeproxy: 10.101.8.1
           mex-flavor: 
  

  

   vm_security_group:
       type: OS::Neutron::SecurityGroup
       properties:
          name: jlmheattest.mobiledgex.net-sg
          rules:
        
          - direction: egress
        
        

   jlmheattest.mobiledgex.net:
      type: OS::Nova::Server
      properties:
         name: jlmheattest.mobiledgex.net
       
       
         image: mobiledgex-v3.0.3
        
         security_groups:
           - { get_resource: vm_security_group }
          
           - 342f6bc4-49ac-4929-9cfb-5c5a5dc4386a
         flavor: m4.small

        
         config_drive: true       
         user_data_format: RAW
         networks:
        
          - network: external-network-shared
        
         metadata:
            skipk8s: yes
            role: mex-agent-node 
            edgeproxy: 10.101.8.1
            mex-flavor: m4.small
           
        
         user_data: |
            #cloud-config
            bootcmd:
             - echo MOBILEDGEX CLOUD CONFIG START
             - echo 'APT::Periodic::Enable "0";' > /etc/apt/apt.conf.d/10cloudinit-disable
             - apt-get -y purge update-notifier-common ubuntu-release-upgrader-core landscape-common unattended-upgrades
             - echo "Removed APT and Ubuntu extra packages" | systemd-cat
            ssh_authorized_keys:
             - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCrHlOJOJUqvd4nEOXQbdL8ODKzWaUxKVY94pF7J3diTxgZ1NTvS6omqOjRS3loiU7TOlQQU4cKnRRnmJW8QQQZSOMIGNrMMInGaEYsdm6+tr1k4DDfoOrkGMj3X/I2zXZ3U+pDPearVFbczCByPU0dqs16TWikxDoCCxJRGeeUl7duzD9a65bI8Jl+zpfQV+I7OPa81P5/fw15lTzT4+F9MhhOUVJ4PFfD+d6/BLnlUfZ94nZlvSYnT+GoZ8xTAstM7+6pvvvHtaHoV4YqRf5CelbWAQ162XNa9/pW5v/RKDrt203/JEk3e70tzx9KAfSw2vuO1QepkCZAdM9rQoCd ubuntu@registry
            chpasswd: { expire: False }
            ssh_pwauth: False
            timezone: UTC
            runcmd:
             - [ echo, MOBILEDGEX, doing, ifconfig ]
             - [ ifconfig, -a ]
        
        
  
  